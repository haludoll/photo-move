# MediaLibrary - ドメインモデル設計書

## 概要

MediaLibraryContextのドメインモデルを、ドメイン駆動設計の原則に基づいて設計します。

## エンティティ (Entities)

### Media（メディア）
写真または動画を表現する中心的な概念

**構成要素:**
- **識別子**: 各メディアを一意に特定するID
- **種類**: 写真または動画
- **ファイルパス**: デバイス内での保存場所
- **メタデータ**: 撮影日時、サイズ、場所などの詳細情報

**特徴:**
- 一意の識別子を持つ
- 一度作成されると変更されない

## 値オブジェクト (Value Objects)

### MediaID（メディア識別子）
メディアを一意に識別するための値

**構成要素:**
- **値**: 文字列形式の識別子

**制約:**
- 空の値は許可されない

### MediaType（メディア種類）
メディアの種類を表現

**値:**
- **写真**: 静止画像

### MediaMetadata（メディアメタデータ）
メディアに関連する基本情報

**構成要素:**
- **ファイル形式**: JPEG、MP4等の形式
- **撮影日時**: いつ撮影されたか

### MediaFormat（メディア形式）
ファイルの形式を表現

**写真形式:**
- JPEG: 標準的な写真形式
- PNG: 透明度を持つ画像形式
- HEIC: iOS標準の高効率形式


### Thumbnail（サムネイル）
一覧表示のためのメディア縮小画像

**構成要素:**
- **対象メディア**: 元となるメディアの識別子
- **画像データ**: 縮小された画像

### PhotoLibraryPermissionStatus（写真ライブラリ権限状態）
写真ライブラリへのアクセス権限の状態を表現

**状態:**
- **notDetermined**: 権限状態が未確認
- **authorized**: 完全なアクセスが許可されている
- **limited**: 制限付きでアクセスが許可されている
- **denied**: アクセスが拒否されている
- **restricted**: システムにより制限されている

## 集約 (Aggregates)

### MediaLibrary（メディアライブラリ）
デバイスの写真ライブラリ全体を管理する中心的な概念

**管理する要素:**
- **写真一覧**: デバイスに保存されているすべての写真
- **権限状態**: 写真ライブラリへのアクセス権限

**提供する機能:**
- **写真取得**: デバイスから写真一覧を取得
- **写真表示**: 取得した写真を一覧で表示
- **権限管理**: 写真ライブラリアクセス権限の確認・要求

## ドメインサービス (Domain Services)

### PhotoLibraryPermissionService（写真ライブラリ権限サービス）
写真ライブラリへのアクセス権限管理を抽象化

**提供する機能:**
- **権限状態確認**: 現在の権限状態を取得
- **権限要求**: ユーザーに権限を要求

**特徴:**
- 外部システム（iOS PhotoKit）への依存を抽象化
- テスト時にはモック実装が使用される
- リポジトリではなくサービスとして定義（データ永続化ではなく外部システム連携）

## アプリケーションサービス (Application Services)

### MediaLibraryService（メディアライブラリサービス）
写真ライブラリの管理に関するユースケースを実装

**提供する機能:**
- **写真一覧取得**: 写真ライブラリから写真一覧を取得
- **権限チェック**: 写真ライブラリへのアクセス権限を確認・要求
- **エラーハンドリング**: 権限エラーや読み込みエラーの処理

**依存関係:**
- MediaRepository: メディアデータの取得
- PhotoLibraryPermissionService: 写真ライブラリ権限の管理

## リポジトリ (Repository)

### MediaRepository（メディアリポジトリ）
メディアデータの取得を担当

**提供する機能:**
- **全メディア取得**: デバイスからすべてのメディアを取得
- **サムネイル取得**: 指定されたメディアのサムネイルを取得

**実装:**
- **MediaRepositoryImpl**: PhotoKitを使用したstruct実装
- **Mock実装**: テスト用のプロトコル準拠モック実装

## 集約の境界

```
Media（メディア集約）
├── Media（集約ルート）
└── Thumbnail（値オブジェクト）
```

## ドメインエラー

### MediaError（メディアエラー）
メディア関連のエラー

**エラー種類:**
- **permissionDenied**: 写真ライブラリへのアクセス権限が拒否されている
- **mediaNotFound**: 指定されたメディアが見つからない
- **invalidMediaID**: 無効または空のメディア識別子
- **thumbnailGenerationFailed**: サムネイル生成に失敗
- **loadingFailed**: メディア読み込みに失敗

## 不変条件

### Media集約の不変条件
- **識別子の一意性**: メディアIDは一意である
- **ファイルパスの有効性**: ファイルパスは有効な形式である
- **サムネイルの整合性**: サムネイルは対応するメディアに属する

## 基本的なビジネスルール（暫定）

> **注意**: 以下のルールは暫定的なものであり、実装時に詳細な挙動を定義していきます。

### メディア管理
- メディアは一意の識別子を持つ
- メディアは撮影日時を基準にソートされる

### サムネイル
- サムネイルは一覧表示時に生成される
- サムネイルはキャッシュされる

## 依存性注入 (Dependency Injection)

### Composition Rootパターン
- **AppDependencies**: アプリケーション全体の依存関係を管理する中央集権的なenum
- **静的プロパティ**: 各依存関係は`static let`プロパティとして定義
- **explicit any**: Swift 6対応のため`any`修飾子を明示的に使用
- **DependencyInjection**モジュールが Composition Root として機能

### 抽象化されたサービス
- **MediaRepository**: プロトコルベースの抽象化
- **PhotoLibraryPermissionService**: プロトコルベースの抽象化
- **MediaLibraryAppService**: アプリケーションサービスの抽象化

### 実装の分離
- **本番環境**: 
  - `MediaRepositoryImpl`: PhotoKitを使用したstruct実装
  - `PhotoLibraryPermissionServiceImpl`: PhotoKitを使用したstruct実装
  - `MediaLibraryAppService`: アプリケーションサービスのstruct実装
- **テスト環境**: 
  - `TestDependencies`: テスト用依存関係管理構造体
  - Mock実装: プロトコル準拠のモック実装

### テスト戦略
- **swift-testing**: 新しいテストフレームワークを使用（XCTest廃止）
- **@Test属性**: XCTestの代わりにswift-testingの@Test属性
- **#expect**: XCTAssertの代わりに#expect マクロ
- **依存性注入**: 外部システム（PhotoKit）に依存しないテストを実現
- **独立実行**: すべてのテストが独立して実行可能
- **struct実装**: ステートレスなサービスはstruct で実装しテスト性向上

## 他のコンテキストとの関係

### AssetTransferContext
- 将来的に、選択されたメディアを転送対象として提供する予定